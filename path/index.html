<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Path</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<style>
  body{
    font-family: 'Open Sans', Arial, sans-serif;
    font-size: 14px;
    color: #616c84;
    background: #ffffff;
    line-height: 1.7em;
    padding: 0;
    margin: 0;
    }

  p{
    margin-top: 0;
    padding-top: 0;
    }

  article{
    width: 320px;
    height: 200px;
    background: #f2f2f2;
    margin: 20px auto;
    position: relative;
    -webkit-transition: all 0.8s cubic-bezier(0.58, -0.55, 0.265, 1.45);
    -ms-transition: all 0.8s cubic-bezier(0.58, -0.55, 0.265, 1.45);
    -moz-transition: all 0.8s cubic-bezier(0.58, -0.55, 0.265, 1.45);
    transition: all 0.8s cubic-bezier(0.58, -0.55, 0.265, 1.45);
    }

  .pieces{
    width: 100px;
    height: 100px;
    position: absolute;
    z-index: 100;
    -webkit-transition: all 0.6s cubic-bezier(0.58, -0.55, 0.265, 1.45);
    -ms-transition: all 0.6s cubic-bezier(0.58, -0.55, 0.265, 1.45);
    -moz-transition: all 0.6s cubic-bezier(0.58, -0.55, 0.265, 1.45);
    transition: all 0.6s cubic-bezier(0.58, -0.55, 0.265, 1.45);
    perspective: 1000;
    }

  #piece-1{
    top: 0;
    left: 0;
    background: url(http://piersrueb.com/puzzle/img/puzzle-1.jpg);
    background-size: cover;
    }

  #piece-2{
    top: 0;
    left: 100px;
    background: url(http://piersrueb.com/puzzle/img/puzzle-2.jpg);
    background-size: cover;
    }

  #piece-3{
    top: 0;
    left: 200px;
    background: url(http://piersrueb.com/puzzle/img/puzzle-3.jpg);
    background-size: cover;
    }

  #piece-4{
    top: 100px;
    left: 0;
    background: url(http://piersrueb.com/puzzle/img/puzzle-4.jpg);
    background-size: cover;
    }

  #piece-5{
    top: 100px;
    left: 100px;
    background: url(http://piersrueb.com/puzzle/img/puzzle-5.jpg);
    background-size: cover;
    }

  #piece-6{
    top: 100px;
    left: 200px;
    background: url(http://piersrueb.com/puzzle/img/puzzle-6.jpg);
    background-size: cover;
    }

  p{
    margin: 20px auto;
    text-align: center;
  }

  .glow{
    z-index: 101;
      -webkit-box-shadow: 0px 0px 6px 0px #000000;
      box-shadow: 0px 0px 6px 0px #000000;
      transform: scale(1.1);
    }

  @-webkit-keyframes animate-guage {
    0%   { transform: scale(1.04); }
    50%   { transform: scale(1.06); }
    100%  { transform: scale(1.04); }
    }

  .glow-2{ -webkit-transform: rotateX(360deg); }

  @-webkit-keyframes animate-guage-2 {
    0%   { transform: scale(1); }
    50%   { transform: scale(1.02); }
    100%  { transform: scale(1); }
    }
  .align-center{
    text-align: center;
    margin: 20px auto;
    padding: 10px;
  }

</style>
<body>
  <div class="align-center">
    <h1>Hello World!</h1>
    <h3 id="param"><b>Query Param: </b></h3>
    <img id="pictureUrl">
    <h3 id="displayName"></h3>
    <h3 id="statusMessage"></h3>

    <article>
      <div class="pieces" id="piece-1"></div>
      <div class="pieces" id="piece-2"></div>
      <div class="pieces" id="piece-3"></div>
      <div class="pieces" id="piece-4"></div>
      <div class="pieces" id="piece-5"></div>
      <div class="pieces" id="piece-6"></div>
    </article>
    
    <p></p>
  </div>
  
  <script>
    // Query Params
    const queryString = decodeURIComponent(window.location.search);
    const params = new URLSearchParams(queryString);
    document.getElementById("param").append(params.get("param"));
  </script>

  <!-- The core Firebase JS SDK is always required and must be listed first -->
  <script src="https://www.gstatic.com/firebasejs/8.1.2/firebase-app.js"></script>

  <!-- TODO: Add SDKs for Firebase products that you want to use
      https://firebase.google.com/docs/web/setup#available-libraries -->
  <script src="https://www.gstatic.com/firebasejs/8.1.2/firebase-analytics.js"></script>

  <script>
    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    var firebaseConfig = {
      apiKey: "AIzaSyAWYLsymh00gcW2kxaSe7LAr6q8nqn6jA8",
      authDomain: "minigamenewyear2020.firebaseapp.com",
      databaseURL: "https://minigamenewyear2020-default-rtdb.firebaseio.com",
      projectId: "minigamenewyear2020",
      storageBucket: "minigamenewyear2020.appspot.com",
      messagingSenderId: "755521062063",
      appId: "1:755521062063:web:dc6547a49cd66823d3805a",
      measurementId: "G-CN5747PXZE"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
  </script>
  <script src="https://static.line-scdn.net/liff/edge/versions/2.5.0/sdk.js"></script>
  <script type="text/javascript" src="https://cdn.rawgit.com/alexgibson/shake.js/master/shake.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js" type="text/javascript"></script>
  <script>
    $(document).ready(function(){ 

      //  globals

      var tileClicked = false;
      var firstTileClicked; 
      var secondTileClicked; 
      var topPosFir = 0;
      var leftPosFir = 0;
      var topPosSec = 0;
      var leftPosSec = 0;
      var shuffle = Math.floor((Math.random() * 4) + 1);
      var moves = 0;
      var secs = 0;

      //  shuffle the tiles

      function shuffleTiles(){
        if(shuffle == 1){
          $('#piece-1').css({top: 100, left: 200});
          $('#piece-2').css({top: 0, left: 200});
          $('#piece-3').css({top: 100, left: 100});
          $('#piece-4').css({top: 0, left: 100});
          $('#piece-5').css({top: 100, left: 0});
          $('#piece-6').css({top: 0, left: 0});
        } else if(shuffle == 2){
          $('#piece-1').css({top: 100, left: 0});
          $('#piece-2').css({top: 0, left: 0});
          $('#piece-3').css({top: 100, left: 100});
          $('#piece-4').css({top: 0, left: 100});
          $('#piece-5').css({top: 100, left: 200});
          $('#piece-6').css({top: 0, left: 200});
        } else if(shuffle == 3){
          $('#piece-1').css({top: 0, left: 200});
          $('#piece-2').css({top: 0, left: 0});
          $('#piece-3').css({top: 100, left: 100});
          $('#piece-4').css({top: 100, left: 200});
          $('#piece-5').css({top: 0, left: 100});
          $('#piece-6').css({top: 100, left: 0});
        } else if(shuffle == 4){
          $('#piece-1').css({top: 0, left: 200});
          $('#piece-2').css({top: 100, left: 200});
          $('#piece-3').css({top: 0, left: 100});
          $('#piece-4').css({top: 100, left: 100});
          $('#piece-5').css({top: 0, left: 0});
          $('#piece-6').css({top: 100, left: 0});
        }
      }

      $(window).load(function(){
        setTimeout(function(){
          shuffleTiles();
          setInterval(function(){ 
            secs++ 
          }, 1000);
        }, 1000);
      });

      //  play the game

      $('.pieces').click(function(){

        if(tileClicked == false){  //  if no tile is clicked

          //  set variables
          firstTileClicked = $(this).attr('id');
          topPosFir = parseInt($(this).css('top')); 
          leftPosFir = parseInt($(this).css('left')); 

          //  highlight tile
          $(this).addClass('glow');
          tileClicked = true;

        } else{  //  if you've clicked a tile

          //  set variables
          secondTileClicked = $(this).attr('id');
          topPosSec = parseInt($(this).css('top')); 
          leftPosSec = parseInt($(this).css('left'));

          //  animations
          $('#' + firstTileClicked).css({'top' : topPosSec , 'left' : leftPosSec});
          $('#' + secondTileClicked).css({'top' : topPosFir , 'left' : leftPosFir});

          //  remove the glow and reset the first tile
          $('.pieces').removeClass('glow');
          tileClicked = false;

          //  test for the win

          setTimeout(function(){
            if(
              $('#piece-1').css('left') == '0px' && $('#piece-1').css('top') == '0px' && 
              $('#piece-2').css('left') == '100px' && $('#piece-2').css('top') == '0px' &&
              $('#piece-3').css('left') == '200px' && $('#piece-3').css('top') == '0px' &&
              $('#piece-4').css('left') == '0px' && $('#piece-4').css('top') == '100px' &&
              $('#piece-5').css('left') == '100px' && $('#piece-5').css('top') == '100px' &&
              $('#piece-6').css('left') == '200px' && $('#piece-6').css('top') == '100px' 
            ){
              $('p').text('You have solved the puzzle in ' + secs + ' seconds using ' + moves + ' moves!!');
              $('article').addClass('glow-2');
              moves = 0;
            }
          }, 1000);

          //  increment the move counter
          moves++

        }

      });  //  end the click function

    });
    async function getUserProfile() {
      const profile = await liff.getProfile()
      document.getElementById("pictureUrl").src = profile.pictureUrl
      document.getElementById("statusMessage").append(profile.statusMessage)
      document.getElementById("displayName").append(profile.displayName)
      const dbRef = firebase.database().ref(); 
      const usersRef = dbRef.child('games');
      let newUser = {
        userId: profile.userId,
        displayName: profile.displayName,
        pictureUrl: profile.pictureUrl,
        timeScore: 0.0,
        moveScore: 0
      }
      usersRef.push(newUser)
    }
    async function main() {
      await liff.init({ liffId: "1655315308-k2ZaAZZm" })
      if (liff.isLoggedIn()) {
        getUserProfile()
      } else {
        liff.login({ redirectUri: "https://hgcassiopeia.github.io/minigame2021/path/" })
      }
    }
    main()
  </script>
</body>

</html>
